# Spine Protobuf Compiler plugin

Spine uses [Google Protobuf](https://developers.google.com/protocol-buffers/) as a model definition
language. Some of the framework features require compile-time processing of the data model. For that
a plugin into a Protobuf compiler (a.k.a. `protoc`) is implemented.

## Features

### `(is)`/`(every_is)`

Spine `protoc` plugin enables the user to mark certain message classes with interfaces.

To mark a certain message type, add the `(is)` option for the type:

```proto
import "spine/options.proto";

message Cat {
    option (is).java_type = "org.example.Pet";
    option (is).generate = true;
    
    // ...
}
``` 
After recompiling the definition with the Spine Protobuf plugin, a `.java` file declaring the 
`org.example.Pet` interface will be generated and the `Cat` java class will implement that 
interface.

The file with the interface declaration is generated alongside the message class files.

In order to use an existing interface, just don't set `(is).generate = true`.

Similarly to `(is)` option, file-level `(every_is)` option declares that all the message types 
declared in the current file implement the given interface.

```proto
import "spine/options.proto";

option (every_is) = "org.example.Pet";

message Cat {
    // ...
}

message Dog {
    // ...
}

message Hamster {
    // ...
}
```

If both `(is)` and `(every_is)` options are found, both are applied.

Also, both `(is)` and `(every_is)` options support shorter syntax with no explicit package 
declaration. In this case, the package of the current file (either `java_package` or Protobuf
`package`) is used.
```proto
package example;

import "spine/options.proto";

option java_package = "org.example.pet";

message Mouse {
    option (is) = {java_type: "SmallPet" generate: true};
    
    // ...
}
```

In the example above, the Java FQN of the generated message interface is 
`org.example.pet.SmallPet`.
If `java_package` option is absent, the Protobuf package is used instead.

#### Code generation from configuration

The plugin supports a multitude of code generation functions, such as adding interfaces to messages
by a pattern, generating extra methods and nested classes, generating data validation based on Spine
options, etc. See `spine.tools.protoc.SpineProtocConfig` for all the functions and their
configuration.

## Usage

To enable the Spine `protoc` plugin, use the Spine Gradle plugin and 
the [Protobuf Gradle plugin](https://github.com/google/protobuf-gradle-plugin):
```groovy
apply plugin: "io.spine.tools.mc-java"
apply plugin: "com.google.protobuf"
```

Make sure to use the Protobuf Gradle plugin of version `0.8.13` or later.

The Spine Gradle plugin automatically attaches the Spine `protoc` plugin to the Protobuf compilation
process performed by Protobuf Gradle plugin.

## How it works

#### Assembling

The plugin is a self-executable JAR with the `protoc` plugin.
 
Both the plugins are published alongside with the Spine Gradle plugin. To update the `protoc` 
plugin, the user should update the Gradle plugin.

The JAR contains a simple Java program, which reads from stdin and writes into stdout according to 
the [Protobuf compiler contract](https://developers.google.com/protocol-buffers/docs/reference/other#plugins).

#### Configuration

Spine Gradle plugin configures the project with the notation provided by the Protobuf Gradle plugin.
This includes fetching the required artifacts and referencing them to the Protobuf plugin.

The Protobuf Gradle plugin fetches and launches an executable JAR (a JAR with the main class
defined in the manifest file).

#### Compilation

`protoc` invokes our executable and passes a serialized message to it via standard I/O. 
The JAR executable returns its output to `protoc` (also via standard I/O).

On the Protobuf compile time, the plugin handles the code generation requests from `protoc`.
The response contains the Java code to be written. For example, for generating message interfaces, 
plugin responds with the code of the message interfaces themselves and the insertion points, which 
make the message types implement the requested interfaces.

The files generated by the plugin are written under `java` subdirectory of the generation target
directory (which is by default set to `<projectDir>/generated`).
 
If the passed code gen request is not interesting to the Spine plugin, the response is empty.

---

For the details on the `protoc` plugin development, see the official 
[doc](https://developers.google.com/protocol-buffers/docs/reference/other#plugins).
